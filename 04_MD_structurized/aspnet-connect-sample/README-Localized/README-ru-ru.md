# Пример приложения, подключающегося с использованием Microsoft Graph, для ASP.NET 4.6

## Содержание

* [Необходимые компоненты](#Необходимые-компоненты)
* [Регистрация приложения](#Регистрация-приложения)
* [Сборка и запуск примера](#Сборка-и-запуск-примера)
* [Полезный код](#Полезный-код)
* [Вопросы и комментарии](#Вопросы-и-комментарии)
* [Участие](#Участие)
* [Дополнительные ресурсы](#Дополнительные-ресурсы)

В этом примере показано, как подключить веб-приложение ASP.NET 4.6 MVC к рабочей или учебной (Azure Active Directory) либо личной учетной записи Майкрософт с помощью API Microsoft Graph для отправки электронной почты. Для работы с данными, возвращаемыми Microsoft Graph, используется [клиентская библиотека Microsoft Graph .NET](https://github.com/microsoftgraph/msgraph-sdk-dotnet). 

Кроме того, для проверки подлинности в этом примере используется [Microsoft Authentication Library (MSAL)](https://www.nuget.org/packages/Microsoft.Identity.Client/). Пакет SDK MSAL предоставляет функции для работы с [конечной точкой проверки подлинности версии 2](https://azure.microsoft.com/en-us/documentation/articles/active-directory-appmodel-v2-overview), которая позволяет разработчикам создать один блок кода для проверки подлинности как рабочих или учебных (Azure Active Directory), так и личных учетных записей (Майкрософт).

 > **Примечание**. Сейчас доступна предварительная версия пакета SDK MSAL, поэтому его не следует использовать в рабочем коде. Он используется здесь только в демонстрационных целях.

## Необходимые компоненты

Для этого примера требуются следующие компоненты:  

  * [Visual Studio 2015;](https://www.visualstudio.com/en-us/downloads) 
  * [учетная запись Майкрософт](https://www.outlook.com) или [учетная запись Office 365 для бизнеса](https://msdn.microsoft.com/en-us/office/office365/howto/setup-development-environment#bk_Office365Account). Вы можете [подписаться на план Office 365 для разработчиков](https://msdn.microsoft.com/en-us/office/office365/howto/setup-development-environment#bk_Office365Account), который включает ресурсы, необходимые для создания приложений Office 365.

## Регистрация приложения

1. Войдите на [портал регистрации приложений](https://apps.dev.microsoft.com/) с помощью личной, рабочей или учебной учетной записи.

2. Нажмите кнопку **Добавить приложение**.

3. Введите имя приложения и нажмите кнопку **Создать приложение**. 
    
   Откроется страница регистрации со свойствами приложения.

4. Скопируйте идентификатор приложения. Это уникальный идентификатор приложения. 

5. В разделе **Секреты приложения** нажмите кнопку **Создать новый пароль**. Скопируйте пароль из диалогового окна **Новый пароль создан**.

   Идентификатор приложения и пароль будут использованы для настройки примера приложения в следующем разделе. 

6. В разделе **Платформы** выберите элемент **Добавление платформы**.

7. Выберите пункт **Веб**.

8. Убедитесь, что установлен флажок **Разрешить неявный поток**, и введите универсальный код ресурса (URI) перенаправления *https://localhost:44300/*. 

   Параметр **Разрешить неявный поток** включает гибридный поток. Благодаря этому при проверке подлинности приложение может получить данные для входа (id_token) и артефакты (в данном случае — код авторизации), которые оно может использовать, чтобы получить маркер доступа.

9. Нажмите кнопку **Сохранить**.

## Сборка и запуск примера

1. Скачайте или клонируйте пример приложения, подключающегося с использованием Microsoft Graph, для ASP.NET 4.6.

2. Откройте пример решения в Visual Studio.

3. В корневом каталоге в файле Web.config замените заполнители **ida:AppId** и **ida:AppSecret** на идентификатор приложения и пароль, которые вы скопировали при регистрации приложения.

4. Нажмите клавишу F5 для сборки и запуска примера. При этом будут восстановлены зависимости пакета NuGet и откроется приложение.

   >Если при установке пакетов возникают ошибки, убедитесь, что локальный путь к решению не слишком длинный. Чтобы устранить эту проблему, переместите решение ближе к корню диска.

5. Войдите с помощью личной, рабочей или учебной учетной записи и предоставьте необходимые разрешения.

6. Нажмите кнопку **Получить адрес электронной почты**. После завершения операции на странице отобразится адрес электронной почты пользователя, который вошел в систему.

7. При необходимости измените список получателей и тему сообщения электронной почты, а затем нажмите кнопку **Отправить сообщение**. Под кнопкой отобразится сообщение об успешной отправке почты.

## Полезный код

- [Startup.Auth.cs](/Microsoft%20Graph%20SDK%20ASPNET%20Connect/Microsoft%20Graph%20SDK%20ASPNET%20Connect/App_Start/Startup.Auth.cs). Проверяет подлинность текущего пользователя и инициализирует кэш маркеров примера.

- [SessionTokenCache.cs](/Microsoft%20Graph%20SDK%20ASPNET%20Connect/Microsoft%20Graph%20SDK%20ASPNET%20Connect/TokenStorage/SessionTokenCache.cs). Хранит информацию о маркере пользователя. Вы можете заменить его на собственный кэш маркеров. Дополнительные сведения см. в статье [Кэширование маркеров доступа в мультитенантном приложении](https://azure.microsoft.com/en-us/documentation/articles/guidance-multitenant-identity-token-cache/).

- [SampleAuthProvider.cs](/Microsoft%20Graph%20SDK%20ASPNET%20Connect/Microsoft%20Graph%20SDK%20ASPNET%20Connect/Helpers/SampleAuthProvider.cs). Реализует локальный интерфейс IAuthProvider и получает маркер доступа с помощью метода MSAL **AcquireTokenSilentAsync**. Вы можете заменить его на собственного поставщика проверки подлинности. 

- [SDKHelper.cs](/Microsoft%20Graph%20SDK%20ASPNET%20Connect/Microsoft%20Graph%20SDK%20ASPNET%20Connect/Helpers/SDKHelper.cs). Инициализирует класс **GraphServiceClient** из [клиентской библиотеки .NET Microsoft Graph](https://github.com/microsoftgraph/msgraph-sdk-dotnet), используемой для взаимодействия с Microsoft Graph.

- [HomeController.cs](/Microsoft%20Graph%20SDK%20ASPNET%20Connect/Microsoft%20Graph%20SDK%20ASPNET%20Connect/Controllers/HomeController.cs). Содержит методы, которые используют класс **GraphServiceClient** для создания и отправки вызовов в службу Microsoft Graph и обработки ответа.
   - Действие **GetMyEmailAddress** позволяет получить адрес электронной почты текущего пользователя из свойства **mail** или **userPrincipalName**.
   - Действие **SendMail** позволяет отправить сообщение электронной почты от имени текущего пользователя.

- [Graph.cshtml](/Microsoft%20Graph%20SDK%20ASPNET%20Connect/Microsoft%20Graph%20SDK%20ASPNET%20Connect/Views/Home/Graph.cshtml). Содержит пользовательский интерфейс образца. 

## Вопросы и комментарии

Мы будем рады узнать ваше мнение об этом примере. Вы можете отправлять нам свои вопросы и предложения на вкладке [Issues](https://github.com/microsoftgraph/aspnet-connect-sample/issues) (Проблемы) этого репозитория.

Ваше мнение важно для нас. Для связи с нами используйте сайт [Stack Overflow](http://stackoverflow.com/questions/tagged/microsoftgraph). Помечайте свои вопросы тегом [MicrosoftGraph].

## Участие ##

Если вы хотите добавить код в этот пример, просмотрите статью [CONTRIBUTING.md](CONTRIBUTING.md).

Этот проект соответствует [правилам поведения Майкрософт, касающимся обращения с открытым кодом](https://opensource.microsoft.com/codeofconduct/). Читайте дополнительные сведения в [разделе вопросов и ответов по правилам поведения](https://opensource.microsoft.com/codeofconduct/faq/) или отправляйте новые вопросы и замечания по адресу [opencode@microsoft.com](mailto:opencode@microsoft.com).

## Дополнительные ресурсы

- [Другие примеры приложений, подключающихся с использованием Microsoft Graph](https://github.com/MicrosoftGraph?utf8=%E2%9C%93&query=-Connect)
- [Общие сведения о Microsoft Graph](http://graph.microsoft.io)
- [Примеры кода решений для Office](http://dev.office.com/code-samples)
- [Центр разработки для Office](http://dev.office.com/)

## Авторское право
(c) Корпорация Майкрософт (Microsoft Corporation), 2016. Все права защищены.


