# Библиотека фрагментов кода Microsoft Graph SDK для Xamarin.Forms

##Содержание

* [Необходимые компоненты](#Необходимые-компоненты)
* [Регистрация и настройка приложения](#Регистрация-и-настройка-приложения)
* [Сборка и отладка](#Сборка-и-отладка)
* [Запуск приложения](#Запуск-приложения)
* [Как пример влияет на данные учетной записи](#Как-пример-влияет-на-данные-учетной-записи)
* [Добавление фрагмента](#Добавление-фрагмента)
* [Вопросы и комментарии](#Вопросы-и-комментарии)
* [Участие](#Участие)
* [Дополнительные ресурсы](#Дополнительные-ресурсы)

<a name="introduction"></a> В этом примере представлены фрагменты кода, использующие Microsoft Graph для отправки электронной почты, управления группами и выполнения других стандартных задач из приложения Xamarin.Forms. Для работы с данными, возвращаемыми Microsoft Graph, используется [клиентский пакет SDK .NET Microsoft Graph](https://github.com/microsoftgraph/msgraph-sdk-dotnet). 

Для проверки подлинности в этом примере используется [Microsoft Authentication Library (MSAL)](https://www.nuget.org/packages/Microsoft.Identity.Client/). Пакет SDK MSAL предоставляет функции для работы с [конечной точкой проверки подлинности версии 2](https://graph.microsoft.io/en-us/docs/authorization/converged_auth), которая позволяет разработчикам создать один блок кода для проверки подлинности как в рабочих или учебных (Azure Active Directory), так и в личных учетных записях (Майкрософт), в том числе Office 365, Outlook.com и OneDrive.

> **Примечание**. Сейчас доступна предварительная версия SDK MSAL, поэтому его не следует использовать в рабочем коде. Он используется здесь только в демонстрационных целях.

В приложении отображаются типичные задачи или "истории". Каждая история состоит из одного или нескольких фрагментов кода. Истории группируются по типу учетной записи и уровню разрешений. Пользователь может войти в свою учетную запись и выполнить выбранные задачи. Выполненные задачи обозначаются зеленым цветом, а не выполненные — красным. Дополнительные сведения отправляются в окно Output.

<a name="prerequisites"></a>
## Необходимые компоненты ##

Для этого примера требуется следующее:  

  * [Visual Studio 2015](https://www.visualstudio.com/downloads) 
  * [Xamarin для Visual Studio](https://www.xamarin.com/visual-studio)
  * Windows 10 ([с включенным режимом разработки](https://msdn.microsoft.com/library/windows/apps/xaml/dn706236.aspx));
  * учетная запись [Майкрософт](https://www.outlook.com) или [учетная запись Office 365 для бизнеса](https://msdn.microsoft.com/office/office365/howto/setup-development-environment#bk_Office365Account).

Чтобы выполнить проект iOS в этом примере, потребуются перечисленные ниже компоненты.

  * Последний пакет SDK для iOS
  * Последняя версия Xcode
  * Mac OS X Yosemite (10.10) и более поздних версий 
  * [Xamarin.iOS](https://developer.xamarin.com/guides/ios/getting_started/installation/mac/)
  * [Агент Xamarin Mac, подключенный к Visual Studio](https://developer.xamarin.com/guides/ios/getting_started/installation/windows/connecting-to-mac/)

Вы можете использовать [эмулятор Visual Studio для Android](https://www.visualstudio.com/features/msft-android-emulator-vs.aspx), чтобы запустить проект Android.

<a name="register"></a>
##Регистрация и настройка приложения

1. Войдите на [портал регистрации приложений](https://apps.dev.microsoft.com/) с помощью личной, рабочей или учебной учетной записи.
2. Выберите пункт **Добавить приложение**.
3. Введите имя приложения и выберите пункт **Создать приложение**.
    
    Откроется страница регистрации со свойствами приложения.
 
4. В разделе **Платформы** выберите пункт **Добавление платформы**.
5. Выберите пункт **Мобильное приложение**.
6. Скопируйте значение идентификатора клиента (App Id) в буфер обмена. Эти значения потребуется ввести в примере приложения.

    Идентификатор приложения является уникальным.

7. Нажмите кнопку **Сохранить**.

<a name="build"></a>
## Сборка и отладка ##

**Примечание.** Если во время установки пакетов при выполнении шага 2 возникают ошибки, убедитесь, что локальный путь к решению не слишком длинный. Чтобы устранить эту проблему, переместите решение ближе к корню диска.

1. Откройте файл App.cs в проекте решения **Graph_Xamarin_CS_Snippets (Portable)**.

    ![Снимок экрана: панель обозревателя решений в Visual Studio, в проекте Graph_Xamarin_CS_Snippets выбран файл App.cs](../readme-images/Appdotcs.png "Откройте файл App.cs в проекте Graph_Xamarin_CS_Snippets")

2. Когда вы загрузите решение в Visual Studio, настройте пример на использование зарегистрированного идентификатора клиента, сделав его значением переменной **ClientId** в файле App.cs.


    ![Снимок экрана: переменная ClientId в файле App.cs, в настоящее время — пустая строка.](../readme-images/appId.png "Значение идентификатора клиента в файле App.cs")

2.  Если вы планируете входить в приложение с помощью рабочей или учебной учетной записи без прав администратора, необходимо закомментировать код, который запрашивает права администратора. Если этого не сделать, вы не сможете войти с помощью рабочей или учебной учетной записи (при входе с помощью личной учетной записи эти запросы игнорируются.)

    Закомментируйте указанные ниже запросы разрешений в методе `GetTokenForUserAsync()` файла `AuthenticationHelper.cs`.
    
    ```
        "https://graph.microsoft.com/Directory.AccessAsUser.All",
        "https://graph.microsoft.com/User.ReadWrite.All",
        "https://graph.microsoft.com/Group.ReadWrite.All",
    ```

3. Выберите проект, который следует выполнить. Если выбрать универсальную платформу Windows, пример можно запустить на локальном компьютере. Чтобы запустить проект iOS, вам потребуется подключиться к [компьютеру Mac, на котором установлены средства Xamarin](https://developer.xamarin.com/guides/ios/getting_started/installation/windows/connecting-to-mac/). (Вы также можете открыть это решение в Xamarin Studio на компьютере Mac и запустить пример прямо оттуда.) Вы можете использовать [эмулятор Visual Studio для Android](https://www.visualstudio.com/features/msft-android-emulator-vs.aspx), чтобы запустить проект Android. 

    ![Снимок экрана: панель инструментов Visual Studio, выбрана iOS.](../readme-images/SelectProject.png "Выберите проект в Visual Studio")

4. Нажмите клавишу F5 для сборки и отладки. Запустите решение и войдите в систему с помощью личной, рабочей или учебной учетной записи.
    > **Примечание.** Возможно, потребуется открыть диспетчер конфигурации сборки и убедиться, что для проекта UWP выбраны этапы сборки и развертывания.

<a name="run"></a>
## Запуск приложения

Когда вы запустите приложение, в нем появится список типичных задач или "историй". Каждая история состоит из одного или нескольких фрагментов кода. Истории группируются по типу учетной записи и уровню разрешений:

- Задачи, доступные для рабочих, учебных и личных учетных записей, например получение и отправка электронной почты, создание файлов и т. д.
- Задачи, доступные только для рабочих или учебных учетных записей, например получение фотографии учетной записи или сведений о руководителе пользователя.
- Задачи, доступные только для рабочей или учебной учетной записи с административными разрешениями, например получение сведений о членах группы или создание учетных записей пользователей.

Выберите нужные истории и нажмите кнопку "run selected". Вам будет предложено войти с помощью рабочей, учебной или личной учетной записи. Обратите внимание, что при входе с помощью учетной записи, у которой нет необходимых разрешений (например, при выборе историй, доступных только для рабочей или учебной учетной записи, и входе с помощью личной учетной записи), истории выполнить не удастся.

Выполненные задачи обозначаются зеленым цветом, а не выполненные — красным. Дополнительные сведения отправляются в окно Output. 

<a name="#how-the-sample-affects-your-tenant-data"></a>
##Как пример влияет на данные учетной записи

Это приложение выполняет команды по созданию, чтению, обновлению и удалению данных. Оно не изменит и не удалит данные вашей учетной записи. Но оно может создать и оставить артефакты данных в вашей учетной записи: выполняя команды по созданию, обновлению и удалению, приложение создает фиктивные объекты, например новых пользователей или группы, чтобы не изменять данные вашей учетной записи. 

Приложение может оставить эти фиктивные объекты в вашей учетной записи, если вы выберите истории, которые создают или обновляют объекты. Например, при выборе истории "update group" создается группа, которая затем обновляется. В этом случае новая группа останется в вашей учетной записи после работы приложения.

<a name="add-a-snippet"></a>
##Добавление фрагмента

Этот проект включает два файла фрагментов: 

- Groups\GroupSnippets.cs 
- Users\UserSnippets.cs.

Если вы хотите использовать в проекте свой фрагмент кода, просто выполните следующие действия:

1. **Добавьте фрагмент в файл фрагментов.** Не забудьте включить блок try/catch. 

        public static async Task<string> GetMeAsync()
        {
            string currentUserName = null;

            try
            {
                var graphClient = AuthenticationHelper.GetAuthenticatedClientAsync();

                var currentUserObject = await graphClient.Me.Request().GetAsync();
                currentUserName = currentUserObject.DisplayName;

                if ( currentUserName != null)
                {
                    Debug.WriteLine("Got user: " + currentUserName);
                }

            }

2. **Создайте историю, использующую ваш фрагмент, и добавьте ее в связанный файл историй.** Например, история `TryGetMeAsync()` использует фрагмент `GetMeAsync()` в файле Users\UserStories.cs:

        public static async Task<bool> TryGetMeAsync()
        {
            var currentUser = await UserSnippets.GetMeAsync();

            return currentUser != null;
        }        


Иногда истории нужны дополнительные фрагменты. Например, если вы хотите обновить событие, сначала нужно создать его с помощью метода `CreateEventAsync()`. Затем вы сможете обновить его. Всегда используйте фрагменты из файла фрагментов. Если нужная операция отсутствует, создайте ее и включите в свою историю. Рекомендуем удалять все объекты, которые вы создаете в истории, особенно если вы работаете не в тестовой учетной записью и не в учетной записи разработчика.

3. **Добавьте свою историю в список историй в файле MainPage.xaml.cs** (в методе `CreateStoryList()`):
    
    `snippetList.Children.Add(new CheckBox 
        { StoryName = "Get Me", GroupName = "Users", AccountType = "All", RunStoryAsync = UserStories.TryGetMeAsync });`
    
Теперь вы можете проверить свой фрагмент кода. Когда вы запустите приложение, ваша история появится в списке. Установите флажок возле фрагмента и запустите его. Приступайте к отладке фрагмента.

<a name="questions"></a>
## Вопросы и комментарии

Мы будем рады узнать ваше мнение о примере фрагментов кода Microsoft Graph для Xamarin.Forms. Вы можете отправлять нам вопросы и предложения на вкладке [Issues](https://github.com/MicrosoftGraph/xamarin-csharp-snippets-sample/issues) этого репозитория.

Ваше мнение важно для нас. Для связи с нами используйте сайт [Stack Overflow](http://stackoverflow.com/questions/tagged/office365+or+microsoftgraph). Помечайте свои вопросы тегом [MicrosoftGraph].

<a name="contributing"></a>
## Добавление кода ##

Если вы хотите добавить код в этот пример, просмотрите статью [CONTRIBUTING.MD](/CONTRIBUTING.md).

Этот проект соответствует [правилам поведения Майкрософт, касающимся обращения с открытым кодом](https://opensource.microsoft.com/codeofconduct/). Читайте дополнительные сведения в [разделе вопросов и ответов по правилам поведения](https://opensource.microsoft.com/codeofconduct/faq/) или отправляйте новые вопросы и замечания по адресу [opencode@microsoft.com](mailto:opencode@microsoft.com).


<a name="additional-resources"></a>
## Дополнительные ресурсы ##

- [Другие примеры Microsoft Graph Connect](https://github.com/MicrosoftGraph?utf8=%E2%9C%93&query=-Connect)
- [Общие сведения о Microsoft Graph](http://graph.microsoft.io)
- [Примеры кода приложений для Office](http://dev.office.com/code-samples)
- [Центр разработки для Office](http://dev.office.com/)


## Авторское право
(c) Корпорация Майкрософт (Microsoft Corporation), 2016. Все права защищены.

